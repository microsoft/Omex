# OMEX Git Bridge Forward Integration Pipeline

name: $(date:yyyyMMdd)$(rev:.r)
variables:
- name: BuildConfiguration
  value: release
- name: BuildPlatform
  value: any cpu
- name: DisableCfsDetector
  value: true
- name: system.debug
  value: false
- group: OmexOpenSourceExternal-VG
resources:
  repositories:
  - repository: OfficePipelineTemplates
    type: git
    name: OE/OfficePipelineTemplates
    ref: refs/heads/main
  - repository: OmexPipelines
    type: git
    name: OC/OmexPipelines
    ref: refs/heads/main
trigger: none
pr: none
extends:
  template: v1/Office.Unofficial.PipelineTemplate.yml@OfficePipelineTemplates
  parameters:
    pool:
      os: windows
      image: windows-2022
      name: Azure-Pipelines-1ESPT-ExDShared
    customBuildTags:
    - ES365AIMigrationTooling
    stages:
    - stage: Stage
      jobs:
      - job: Job_1
        displayName: Create GitHub Bridge Forward Pull Request
        steps:
        - checkout: self
          clean: true
        - task: PowerShell@2
          displayName: Check New Changes Exist
          inputs:
            targetType: inline
            script: |-
              Write-Host "GITHUBBRANCH being used: '$env:GITHUBBRANCH'"
              Write-Host "GITHUBCOMMIT being used: '$env:GITHUBCOMMIT'"
              if ($env:GITHUBCOMMIT -eq "" -or $env:GITHUBBRANCH -eq "") {
                Write-Host "No commit or branch specified, exiting."
                Write-Host "##vso[task.setvariable variable=ChangesFound]0"
                exit 0
              }
              <#[SuppressMessage("Microsoft.Security", "CS002:SecretInNextLine", Justification="Not a secret")]#>
              git remote add omexgithubremote https://$env:omexgitbotexternalpat@github.com/Microsoft/Omex
              git fetch omexgithubremote
              $files = git diff --name-only origin/$env:GITHUBBRANCH omexgithubremote/$env:GITHUBBRANCH
              if ($files.length -eq 0) {
                Write-Host "No changes between 'origin/$env:GITHUBBRANCH' and 'omexgithubremote/$env:GITHUBBRANCH' found."
                $ChangesFound=0
              } else {
                  Write-Host "Found changes between  'origin/$env:GITHUBBRANCH' and 'omexgithubremote/$env:GITHUBBRANCH'."
                  $ChangesFound=1
              }

              Write-Host "##vso[task.setvariable variable=ChangesFound]$ChangesFound"
          env:
            omexgitbotexternalpat: $(omexgitbotexternalpat)
        - task: PowerShell@2
          displayName: Create Feature Branch For PR Task
          condition: and(succeeded(), ne(variables['ChangesFound'], 0))
          inputs:
            targetType: inline
            script: |-
              $commit = $env:GITHUBCOMMIT
              <#[SuppressMessage("Microsoft.Security", "CS002:SecretInNextLine", Justification="Not a secret")]#>
              git fetch https://$env:omexgitbotexternalpat@github.com/Microsoft/Omex $env:GITHUBBRANCH
              git checkout -b feature/github-bridge-forward $commit
          env:
            omexgitbotexternalpat: $(omexgitbotexternalpat)
        - template: pipelines/templates/git-authenticate-steps-wif.yml@OmexPipelines
          parameters:
            azureServiceConnection: 'OmexGitHubInternal_AdoContributor_UAMI'
            userEmail: 'omexac@microsoft.com'
            username: 'Omex Service Account'
        - task: PowerShell@2
          displayName: Push Branch to ADO
          condition: and(succeeded(), ne(variables['ChangesFound'], 0))
          inputs:
            targetType: inline
            script: |-
              Write-Host "Pushing local branch to ADO as github-bridge-forward-$env:GITHUBCOMMIT..."
              git push origin feature/github-bridge-forward:github-bridge-forward-$env:GITHUBCOMMIT
              if ($LASTEXITCODE -ne 0) {
                Write-Host "##vso[task.logissue type=error]Failed to push branch to ADO."
                exit 1
              }
              Write-Host "Branch pushed successfully to ADO."
        - template: pipelines/templates/create-pull-request-steps-wif.yml@OmexPipelines
          parameters:
            sourceBranchName: 'github-bridge-forward-$(GITHUBCOMMIT)'
            targetBranchName: $(GITHUBBRANCH)
            title: 'GitHub Forward Integration - $(GITHUBCOMMIT)'
            description: 'GitHub forward integration Pull Request for commit ''$(GITHUBCOMMIT)'''
            workItemIds: '9421495'
            enableAutoComplete: true
            mergeStrategy: 'noFastForward'
            condition: and(succeeded(), ne(variables['ChangesFound'], 0))
